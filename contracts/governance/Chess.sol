// SPDX-License-Identifier: MIT
pragma solidity >=0.6.10 <0.8.0;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/math/SafeMath.sol";

import "../interfaces/IChess.sol";
import "../utils/CoreUtility.sol";

import "./ChessRoles.sol";

contract Chess is IChess, Ownable, ERC20, ChessRoles, CoreUtility {
    using SafeMath for uint256;

    /// @dev Hard-coded cumulative weekly supply. Please refer to the whitepaper for details.
    ///      Below are the concrete numbers in this list, which are also tested in "test/chess.ts".
    ///
    ///      ```
    ///      180000000 180300000 180900000 181800000 183000000 185400000 187704000 189915840 192039206 194077638
    ///      196034532 197913151 199716625 201447960 203110041 204705640 206237414 207707917 209119601 210474817
    ///      211775824 213037801 214261919 215449313 216601086 217718305 218802007 219853199 220872855 221861921
    ///      222821315 223751928 224654622 225530235 226379580 227203444 228002592 228777766 229529685 230259047
    ///      230966527 231659858 232339322 233005197 233657754 234297261 234923977 235538159 236140057 236729917
    ///      237307980 237874482 238429653 238973722 239506909 240029432 240541504 241043336 241535130 242017089
    ///      242489409 242957005 243419925 243878217 244331925 244781096 245225776 245666008 246101839 246533311
    ///      246960468 247383354 247802011 248216481 248626807 249033029 249435189 249833328 250227485 250617701
    ///      251004014 251390328 251776641 252162954 252549268 252935581 253321895 253708208 254094522 254480835
    ///      254867149 255253462 255639776 256026089 256412402 256798716 257185029 257571343 257957656 258343970
    ///      258730283 259116597 259502910 259889223 260275537 260661850 261048164 261434477 261820791 262207104
    ///      262593418 262979731 263366045 263752358 264138671 264524985 264911298 265297612 265683925 266070239
    ///      266456552 266842866 267229179 267615492 268001806 268388119 268774433 269160746 269547060 269933373
    ///      270319687 270706000 271092314 271478627 271864940 272251254 272637567 273023881 273410194 273796508
    ///      274182821 274569135 274955448 275341761 275728075 276114388 276500702 276887015 277273329 277659642
    ///      278045956 278432269 278818583 279204896 279591209 279977523 280363836 280750150 281136463 281522777
    ///      281909090 282295404 282681717 283068030 283454344 283840657 284226971 284613284 284999598 285385911
    ///      285772225 286158538 286544852 286931165 287317478 287703792 288090105 288476419 288862732 289249046
    ///      289635359 290021673 290407986 290794299 291180613 291566926 291953240 292339553 292725867 293112180
    ///      293498494 293884807 294271120 294657434 295043747 295430061 295816374 296202688 296589001 296975315
    ///      297361628 297747942 298134255 298520568 298906882 299293195 299679509 300000000
    ///      ```
    bytes private constant CUMULATIVE_SUPPLY_SCHEDULE =
        hex"00000000000000000000000000000000000000000094e47b8d6817153400000000000000000000000000000000000000000000000095240295bfbaf61780000000000000000000000000000000000000000000000095a310a66f02b7de8000000000000000000000000000000000000000000000009661a5bf75ee5a89000000000000000000000000000000000000000000000000975fc1e0d47dde17000000000000000000000000000000000000000000000000995bfa23919ce5330000000000000000000000000000000000000000000000009b43de3aad91b8d30000000000000000000000000000000000000000000000009d183e50dce327d30000000000000000000000000000000000000000000000009ed9e237a62fee5cd80000000000000000000000000000000000000000000000a08989d667e45323580000000000000000000000000000000000000000000000a227ed4619a78eb1100000000000000000000000000000000000000000000000a3b5bd69f43583999c0000000000000000000000000000000000000000000000a533a3ef715ebe79a40000000000000000000000000000000000000000000000a6a243cb3274c6d9600000000000000000000000000000000000000000000000a8023962a26e3a22c40000000000000000000000000000000000000000000000a9541afafb9c68dca00000000000000000000000000000000000000000000000aa98789d863def5bd80000000000000000000000000000000000000000000000abcfdcbe210f219c140000000000000000000000000000000000000000000000acfacc492200bee7240000000000000000000000000000000000000000000000ae19c6b136eea57c640000000000000000000000000000000000000000000000af2d466c4c0c2373400000000000000000000000000000000000000000000000b038825552476ee2040000000000000000000000000000000000000000000000b13bb9e72d584e771c0000000000000000000000000000000000000000000000b2372aa927454556e40000000000000000000000000000000000000000000000b32b1066733e61b9380000000000000000000000000000000000000000000000b417a4f6aac26e4be40000000000000000000000000000000000000000000000b4fd209111e7281efc0000000000000000000000000000000000000000000000b5dbb9cc97593ea4dc0000000000000000000000000000000000000000000000b6b3a576323838bbfc0000000000000000000000000000000000000000000000b78516d645a7f6f3e40000000000000000000000000000000000000000000000b8503fb0a0d0b38d2c0000000000000000000000000000000000000000000000b91550525f95b620e00000000000000000000000000000000000000000000000b9d477762927ec51b80000000000000000000000000000000000000000000000ba8de28993976c110c0000000000000000000000000000000000000000000000bb41bd9f431cbff7700000000000000000000000000000000000000000000000bbf033610962339d500000000000000000000000000000000000000000000000bc996d47685ea238800000000000000000000000000000000000000000000000bd3d938bb19ec2f4d80000000000000000000000000000000000000000000000bddccd28064528f4340000000000000000000000000000000000000000000000be773ff31877aa9d3c0000000000000000000000000000000000000000000000bf0d108469f1fa4c9c0000000000000000000000000000000000000000000000bf9fe210e994e762080000000000000000000000000000000000000000000000c02fc3e220a25841a80000000000000000000000000000000000000000000000c0bcc50a158164b2140000000000000000000000000000000000000000000000c146f439a99a3ae6280000000000000000000000000000000000000000000000c1ce5ff81c30ee1a940000000000000000000000000000000000000000000000c253164fc61d40a9840000000000000000000000000000000000000000000000c2d5252f3ec98d9e5c0000000000000000000000000000000000000000000000c3549a23f8a14670c40000000000000000000000000000000000000000000000c3d18283e3350dfad40000000000000000000000000000000000000000000000c44beb5f8a8404d1b00000000000000000000000000000000000000000000000c4c3e18216fbc945880000000000000000000000000000000000000000000000c53971636cc1c3ba340000000000000000000000000000000000000000000000c5aca76d8f44a8ec280000000000000000000000000000000000000000000000c61d8f8d9b86dcb5540000000000000000000000000000000000000000000000c68c3594ed1d5ba0e00000000000000000000000000000000000000000000000c6f8a50f7c0b9ff5000000000000000000000000000000000000000000000000c762e96d7ee7bca9200000000000000000000000000000000000000000000000c7cb0da245db73d2280000000000000000000000000000000000000000000000c8311caf01c73b2c640000000000000000000000000000000000000000000000c8952133be8c9ee0640000000000000000000000000000000000000000000000c8f825a1cfe6d5b3140000000000000000000000000000000000000000000000c95a2c9358178f07340000000000000000000000000000000000000000000000c9bb38a279607a3f840000000000000000000000000000000000000000000000ca1b4c31d3287821340000000000000000000000000000000000000000000000ca7a69cda6fa8467a00000000000000000000000000000000000000000000000cad893f455aae726c00000000000000000000000000000000000000000000000cb35ccfa9de9cd7c600000000000000000000000000000000000000000000000cb92176cc1423323dc0000000000000000000000000000000000000000000000cbed75919dad91939c0000000000000000000000000000000000000000000000cc47e9cbd292c990d00000000000000000000000000000000000000000000000cca1767dff58bbe0a80000000000000000000000000000000000000000000000ccfa1def01f8e1f98c0000000000000000000000000000000000000000000000cd51e265b86cb551e40000000000000000000000000000000000000000000000cda8c636e16463077c0000000000000000000000000000000000000000000000cdfecb8d996bfd41f40000000000000000000000000000000000000000000000ce53f4b0be7cfd77b40000000000000000000000000000000000000000000000cea843d94dda2977c00000000000000000000000000000000000000000000000cefbbb248358dfc2540000000000000000000000000000000000000000000000cf4e5ccb5c3be626740000000000000000000000000000000000000000000000cfa02add33a1e77cf80000000000000000000000000000000000000000000000cff1f8fcebbe9c7ae00000000000000000000000000000000000000000000000d043c70ec3249dd1640000000000000000000000000000000000000000000000d09595209a8a9f27e80000000000000000000000000000000000000000000000d0e7634052a75425d00000000000000000000000000000000000000000000000d13931522a0d557c540000000000000000000000000000000000000000000000d18aff71e22a0a7a3c0000000000000000000000000000000000000000000000d1dccd83b9900bd0c00000000000000000000000000000000000000000000000d22e9ba371acc0cea80000000000000000000000000000000000000000000000d28069b54912c2252c0000000000000000000000000000000000000000000000d2d237d5012f7723140000000000000000000000000000000000000000000000d32405e6d8957879980000000000000000000000000000000000000000000000d375d40690b22d77800000000000000000000000000000000000000000000000d3c7a21868182ece040000000000000000000000000000000000000000000000d419702a3f7e3024880000000000000000000000000000000000000000000000d46b3e49f79ae522700000000000000000000000000000000000000000000000d4bd0c5bcf00e678f40000000000000000000000000000000000000000000000d50eda7b871d9b76dc0000000000000000000000000000000000000000000000d560a88d5e839ccd600000000000000000000000000000000000000000000000d5b276ad16a051cb480000000000000000000000000000000000000000000000d60444beee065321cc0000000000000000000000000000000000000000000000d65612dea623081fb40000000000000000000000000000000000000000000000d6a7e0f07d890976380000000000000000000000000000000000000000000000d6f9af0254ef0accbc0000000000000000000000000000000000000000000000d74b7d220d0bbfcaa40000000000000000000000000000000000000000000000d79d4b33e471c121280000000000000000000000000000000000000000000000d7ef19539c8e761f100000000000000000000000000000000000000000000000d840e76573f47775940000000000000000000000000000000000000000000000d892b5852c112c737c0000000000000000000000000000000000000000000000d8e4839703772dca000000000000000000000000000000000000000000000000d93651b6bb93e2c7e80000000000000000000000000000000000000000000000d9881fc892f9e41e6c0000000000000000000000000000000000000000000000d9d9ede84b16991c540000000000000000000000000000000000000000000000da2bbbfa227c9a72d80000000000000000000000000000000000000000000000da7d8a0bf9e29bc95c0000000000000000000000000000000000000000000000dacf582bb1ff50c7440000000000000000000000000000000000000000000000db21263d8965521dc80000000000000000000000000000000000000000000000db72f45d4182071bb00000000000000000000000000000000000000000000000dbc4c26f18e80872340000000000000000000000000000000000000000000000dc16908ed104bd701c0000000000000000000000000000000000000000000000dc685ea0a86abec6a00000000000000000000000000000000000000000000000dcba2cc0608773c4880000000000000000000000000000000000000000000000dd0bfad237ed751b0c0000000000000000000000000000000000000000000000dd5dc8e40f537671900000000000000000000000000000000000000000000000ddaf9703c7702b6f780000000000000000000000000000000000000000000000de0165159ed62cc5fc0000000000000000000000000000000000000000000000de53333556f2e1c3e40000000000000000000000000000000000000000000000dea501472e58e31a680000000000000000000000000000000000000000000000def6cf66e6759818500000000000000000000000000000000000000000000000df489d78bddb996ed40000000000000000000000000000000000000000000000df9a6b9875f84e6cbc0000000000000000000000000000000000000000000000dfec39aa4d5e4fc3400000000000000000000000000000000000000000000000e03e07ca057b04c1280000000000000000000000000000000000000000000000e08fd5dbdce10617ac0000000000000000000000000000000000000000000000e0e1a3edb447076e300000000000000000000000000000000000000000000000e133720d6c63bc6c180000000000000000000000000000000000000000000000e185401f43c9bdc29c0000000000000000000000000000000000000000000000e1d70e3efbe672c0840000000000000000000000000000000000000000000000e228dc50d34c7417080000000000000000000000000000000000000000000000e27aaa708b692914f00000000000000000000000000000000000000000000000e2cc788262cf2a6b740000000000000000000000000000000000000000000000e31e46a21aebdf695c0000000000000000000000000000000000000000000000e37014b3f251e0bfe00000000000000000000000000000000000000000000000e3c1e2c5c9b7e216640000000000000000000000000000000000000000000000e413b0e581d497144c0000000000000000000000000000000000000000000000e4657ef7593a986ad00000000000000000000000000000000000000000000000e4b74d1711574d68b80000000000000000000000000000000000000000000000e5091b28e8bd4ebf3c0000000000000000000000000000000000000000000000e55ae948a0da03bd240000000000000000000000000000000000000000000000e5acb75a78400513a80000000000000000000000000000000000000000000000e5fe857a305cba11900000000000000000000000000000000000000000000000e650538c07c2bb68140000000000000000000000000000000000000000000000e6a221abbfdf7065fc0000000000000000000000000000000000000000000000e6f3efbd974571bc800000000000000000000000000000000000000000000000e745bdcf6eab7313040000000000000000000000000000000000000000000000e7978bef26c82810ec0000000000000000000000000000000000000000000000e7e95a00fe2e2967700000000000000000000000000000000000000000000000e83b2820b64ade65580000000000000000000000000000000000000000000000e88cf6328db0dfbbdc0000000000000000000000000000000000000000000000e8dec45245cd94b9c40000000000000000000000000000000000000000000000e93092641d339610480000000000000000000000000000000000000000000000e9826083d5504b0e300000000000000000000000000000000000000000000000e9d42e95acb64c64b40000000000000000000000000000000000000000000000ea25fca7841c4dbb380000000000000000000000000000000000000000000000ea77cac73c3902b9200000000000000000000000000000000000000000000000eac998d9139f040fa40000000000000000000000000000000000000000000000eb1b66f8cbbbb90d8c0000000000000000000000000000000000000000000000eb6d350aa321ba64100000000000000000000000000000000000000000000000ebbf032a5b3e6f61f80000000000000000000000000000000000000000000000ec10d13c32a470b87c0000000000000000000000000000000000000000000000ec629f5beac125b6640000000000000000000000000000000000000000000000ecb46d6dc227270ce80000000000000000000000000000000000000000000000ed063b8d7a43dc0ad00000000000000000000000000000000000000000000000ed58099f51a9dd61540000000000000000000000000000000000000000000000eda9d7b1290fdeb7d80000000000000000000000000000000000000000000000edfba5d0e12c93b5c00000000000000000000000000000000000000000000000ee4d73e2b892950c440000000000000000000000000000000000000000000000ee9f420270af4a0a2c0000000000000000000000000000000000000000000000eef1101448154b60b00000000000000000000000000000000000000000000000ef42de340032005e980000000000000000000000000000000000000000000000ef94ac45d79801b51c0000000000000000000000000000000000000000000000efe67a658fb4b6b3040000000000000000000000000000000000000000000000f0384877671ab809880000000000000000000000000000000000000000000000f08a16893e80b9600c0000000000000000000000000000000000000000000000f0dbe4a8f69d6e5df40000000000000000000000000000000000000000000000f12db2bace036fb4780000000000000000000000000000000000000000000000f17f80da862024b2600000000000000000000000000000000000000000000000f1d14eec5d862608e40000000000000000000000000000000000000000000000f2231d0c15a2db06cc0000000000000000000000000000000000000000000000f274eb1ded08dc5d500000000000000000000000000000000000000000000000f2c6b93da525915b380000000000000000000000000000000000000000000000f318874f7c8b92b1bc0000000000000000000000000000000000000000000000f36a556153f19408400000000000000000000000000000000000000000000000f3bc23810c0e4906280000000000000000000000000000000000000000000000f40df192e3744a5cac0000000000000000000000000000000000000000000000f45fbfb29b90ff5a940000000000000000000000000000000000000000000000f4b18dc472f700b1180000000000000000000000000000000000000000000000f5035be42b13b5af000000000000000000000000000000000000000000000000f55529f60279b705840000000000000000000000000000000000000000000000f5a6f815ba966c036c0000000000000000000000000000000000000000000000f5f8c62791fc6d59f00000000000000000000000000000000000000000000000f64a94474a192257d80000000000000000000000000000000000000000000000f69c6259217f23ae5c0000000000000000000000000000000000000000000000f6ee306af8e52504e00000000000000000000000000000000000000000000000f73ffe8ab101da02c80000000000000000000000000000000000000000000000f791cc9c8867db594c0000000000000000000000000000000000000000000000f7e39abc40849057340000000000000000000000000000000000000000000000f8277896582678ac000000";

    uint256 public immutable startTimestamp;

    constructor(uint256 startTimestamp_) public ERC20("Chess", "CHESS") ChessRoles() {
        require(startTimestamp_ > block.timestamp, "Start timestamp is not in future");
        require(
            endOfWeek(startTimestamp_ - 1) == startTimestamp_,
            "Start timestamp is not start of a trading week"
        );
        _mint(msg.sender, getCumulativeSupply(0));
        startTimestamp = startTimestamp_;
    }

    /// @notice Get length of the supply schedule
    /// @return The length of the supply schedule
    function getScheduleLength() public pure returns (uint256) {
        return CUMULATIVE_SUPPLY_SCHEDULE.length / 32;
    }

    /// @notice Get the cumulative supply at the given week index
    /// @param index Index for cumulative supply
    /// @return currentWeekCumulativeSupply The cumulative supply at the
    ///         beginning of the week
    function getCumulativeSupply(uint256 index)
        public
        pure
        returns (uint256 currentWeekCumulativeSupply)
    {
        (currentWeekCumulativeSupply, ) = getWeeklySupply(index);
    }

    /// @notice Get the total supply and weekly supply at the given week index
    /// @param index Index for weekly supply
    /// @return currentWeekCumulativeSupply The cumulative supply at the
    ///         beginning of the week
    /// @return weeklySupply Weekly supply
    function getWeeklySupply(uint256 index)
        public
        pure
        returns (uint256 currentWeekCumulativeSupply, uint256 weeklySupply)
    {
        uint256 length = getScheduleLength();
        bytes memory scheduleBytes = bytes(CUMULATIVE_SUPPLY_SCHEDULE);

        if (index < length - 1) {
            uint256 offset = (index + 1) * 32;
            uint256 nextWeekCumulativeSupply;
            assembly {
                currentWeekCumulativeSupply := mload(add(scheduleBytes, offset))
                nextWeekCumulativeSupply := mload(add(scheduleBytes, add(offset, 32)))
            }

            weeklySupply = nextWeekCumulativeSupply.sub(currentWeekCumulativeSupply);
        } else {
            uint256 offset = length * 32;
            assembly {
                currentWeekCumulativeSupply := mload(add(scheduleBytes, offset))
            }

            weeklySupply = 0;
        }
    }

    /// @notice Current number of tokens in existence (claimed or unclaimed)
    function availableSupply() public view returns (uint256) {
        if (block.timestamp < startTimestamp) {
            return getCumulativeSupply(0);
        }
        uint256 index = (block.timestamp - startTimestamp) / 1 weeks;
        uint256 currentWeek = index * 1 weeks + startTimestamp;
        (uint256 currentWeekCumulativeSupply, uint256 weeklySupply) = getWeeklySupply(index);
        return
            currentWeekCumulativeSupply.add(
                weeklySupply.mul(block.timestamp - currentWeek).div(1 weeks)
            );
    }

    /// @notice Get the release rate of CHESS token at the given timestamp
    /// @param timestamp Timestamp for release rate
    /// @return Release rate (number of CHESS token per second)
    function getRate(uint256 timestamp) external view override returns (uint256) {
        if (timestamp < startTimestamp) {
            return 0;
        }
        uint256 index = (timestamp - startTimestamp) / 1 weeks;
        (, uint256 weeklySupply) = getWeeklySupply(index);
        return weeklySupply.div(1 weeks);
    }

    /// @notice Creates `amount` CHESS tokens and assigns them to `account`,
    ///         increasing the total supply. This is guarded by `Minter` role.
    /// @param account recipient of the token
    /// @param amount amount of the token
    function mint(address account, uint256 amount) external override onlyMinter {
        require(totalSupply().add(amount) <= availableSupply(), "Exceeds allowable mint amount");
        _mint(account, amount);
    }

    function addMinter(address account) external override onlyOwner {
        _addMinter(account);
    }

    function removeMinter(address account) external onlyOwner {
        _removeMinter(account);
    }
}
